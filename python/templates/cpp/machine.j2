#pragma once
// Generated by StateSurf minimal generator (v1 subset). C++11 header-only.
namespace statesurf {

enum class State {
  {{ pseudo_initial }},
{% for state in states %}
  {{ state }},
{% endfor %}
  {{ pseudo_final }}
};

enum class Event {
{% for event in events %}
  {{ event }}{{ "," if not loop.last else "" }}
{% endfor %}
};

enum class GuardId {
{% for guard in guard_ids %}
  {{ guard }}{{ "," if not loop.last else "" }}
{% endfor %}
};

enum class ActionId {
{% for action in action_ids %}
  {{ action }}{{ "," if not loop.last else "" }}
{% endfor %}
};

struct IHooks {
  virtual ~IHooks() {}
  virtual void on_entry(State) = 0;
  virtual void on_exit(State) = 0;
  virtual bool guard(State, Event, GuardId) = 0;
  virtual void action(State, Event, ActionId) = 0;
};

inline void on_event(State, Event) {}
inline void on_transition(State, State, Event) {}

class {{ machine_name }} {
public:
  explicit {{ machine_name }}(IHooks& impl) : impl_(impl) { reset(); }

  void reset() {
    terminated_ = false;
{% if reset_lines %}
{% for line in reset_lines %}
    {{ line }}
{% endfor %}
{% else %}
    (void)0;
{% endif %}
  }

  void start() {
    if (terminated_ || started_) return;
    started_ = true;
{% if start_target_state %}
    on_transition(State::{{ pseudo_initial }}, State::{{ start_target_state }}, Event{});
    s_ = State::{{ start_target_state }};
{% for line in start_lines %}
    {{ line }}
{% endfor %}
{% else %}
    on_transition(State::{{ pseudo_initial }}, State::{{ pseudo_final }}, Event{});
    impl_.on_entry(State::{{ pseudo_final }});
    s_ = State::{{ pseudo_final }};
    terminated_ = true;
{% endif %}
  }

  State state() const { return s_; }
  bool terminated() const { return terminated_; }

  void dispatch(Event e) {
    if (terminated_) return;
    if (!started_) {
      start();
      if (!started_) return;
    }
    on_event(s_, e);
    switch (s_) {
{% for state in state_cases %}
      case State::{{ state.name }}: {
{% if state.events %}
        switch (e) {
{% for event in state.events %}
          case Event::{{ event.name }}: {
{% for line in event.lines %}
{{ line }}
{% endfor %}
          }
{% endfor %}
          default: return;
        }
{% else %}
        return;
{% endif %}
      }
{% endfor %}
      case State::{{ pseudo_initial }}: {
        return;
      }
      case State::{{ pseudo_final }}: {
        return;
      }
    }
  }

private:
  IHooks& impl_;
  State s_;
  bool started_ = false;
  bool terminated_ = false;
};

} // namespace statesurf
